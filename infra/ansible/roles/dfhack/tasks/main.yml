---
- name: Ensure DFHack build dependencies are installed
  apt:
    name:
      - build-essential
      - cmake
      - ninja-build
      - git
      - libprotobuf-dev
      - protobuf-compiler
      - libsdl2-dev
      - libncursesw6
      - libbz2-dev
      - zlib1g-dev
      - libtinfo-dev
      - pkg-config
      - expect
    state: present
    update_cache: yes
  become: yes

- name: Create DFHack build directories
  file:
    path: "{{ item }}"
    state: directory
    owner: cdossman
    group: cdossman
    mode: '0755'
  loop:
    - /opt/dfhack-src
    - /opt/dfhack-build
  become: yes

- name: Sync DFHack source tree to target
  command: >-
    rsync --archive --compress --delete
          --rsync-path="mkdir -p /opt/dfhack-src && rsync"
          --rsh="ssh -i {{ ansible_ssh_private_key_file }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          /Users/cdossman/dfhack-work/src/ {{ ansible_user }}@{{ ansible_host }}:/opt/dfhack-src/
  delegate_to: localhost
  become: no

- name: Apply core autoboot patch to DFHack
  ansible.builtin.patch:
    src: "{{ role_path }}/../../files/dfhack-core-autoboot.patch"
    basedir: /opt/dfhack-src
    strip: 1
  become: yes

- name: Configure DFHack
  command: >-
    cmake -S /opt/dfhack-src
          -B /opt/dfhack-build
          -G Ninja
          -DCMAKE_BUILD_TYPE=RelWithDebInfo
          -DCMAKE_INSTALL_PREFIX=/opt/dwarf-fortress
  args:
    creates: /opt/dfhack-build/build.ninja
  become: yes

- name: Build DFHack
  command: cmake --build /opt/dfhack-build -j
  become: yes

- name: Install DFHack into Dwarf Fortress bundle
  command: cmake --install /opt/dfhack-build
  become: yes

- name: Ensure DFHack config directory exists
  file:
    path: /opt/dwarf-fortress/dfhack-config
    state: directory
    mode: '0755'
  become: yes

- name: Ensure Dwarf Fortress init uses TEXT mode
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[PRINT_MODE'
    line: '[PRINT_MODE:TEXT]'
  become: yes

- name: Ensure Dwarf Fortress intro movie is disabled
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[INTRO'
    line: '[INTRO:OFF]'
  become: yes

- name: Ensure Dwarf Fortress does not prompt for fullscreen toggle
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[ASK_TOGGLE_FULLSCREEN'
    line: '[ASK_TOGGLE_FULLSCREEN:NO]'
  become: yes

- name: Ensure Dwarf Fortress fullscreen defaults to NO
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[FULLSCREEN'
    line: '[FULLSCREEN:NO]'
  become: yes

- name: Ensure Dwarf Fortress text font is curses
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[TEXT_FONT'
    line: '[TEXT_FONT:curses_640x300.bmp]'
  become: yes

- name: Ensure Dwarf Fortress window font is curses
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[FONT'
    line: '[FONT:curses_640x300.bmp]'
  become: yes

- name: Ensure Dwarf Fortress full font is curses
  lineinfile:
    path: /opt/dwarf-fortress/data/init/init.txt
    regexp: '^\s*\[FULLFONT'
    line: '[FULLFONT:curses_640x300.bmp]'
  become: yes

- name: Write remote-server.json
  copy:
    dest: /opt/dwarf-fortress/dfhack-config/remote-server.json
    mode: '0644'
    content: |
      { "port": 5000, "allow_remote": false }
  notify: Restart dfhack
  become: yes

- name: Remove legacy autoboot plugin autoload
  file:
    path: /opt/dwarf-fortress/dfhack-config/autoload/autoboot_remote.plugin
    state: absent
  become: yes

- name: Install dfhack headless launcher script
  copy:
    src: "{{ role_path }}/../../files/dfhack-headless.sh"
    dest: /opt/dwarf-fortress/bin/dfhack-headless.sh
    mode: '0755'
  notify: Restart dfhack
  become: yes

- name: Install dfhack headless PTY expect wrapper
  copy:
    src: "{{ role_path }}/../../files/dfhack-headless-pty.exp"
    dest: /opt/dwarf-fortress/bin/dfhack-headless-pty.exp
    mode: '0755'
  notify: Restart dfhack
  become: yes

- name: Install DFHack headless systemd unit
  copy:
    src: "{{ role_path }}/../../files/dfhack-headless.service"
    dest: /etc/systemd/system/dfhack-headless.service
    mode: '0644'
  notify: Restart dfhack
  become: yes

- name: Enable dfhack-headless service
  systemd:
    name: dfhack-headless
    enabled: true
  become: yes

- name: Verify DFHack RPC listener is active
  shell: "ss -lntp | grep -E '127\\.0\\.0\\.1:5000.+dwarfort'"
  register: dfhack_listener
  changed_when: false
  retries: 15
  delay: 2
  until: dfhack_listener.rc == 0
  become: yes

- name: Verify dfhack-run can connect
  shell: "cd /opt/dwarf-fortress && ./dfhack-run help >/dev/null"
  register: dfhack_run
  changed_when: false
  retries: 5
  delay: 2
  until: dfhack_run.rc == 0
  become: yes
